/**
 * This ruleset enforces a security model for an internal store management system with Role-Based Access Control (RBAC).
 *
 * Core Philosophy:
 * The security model enforces three user roles: admin, trial users, and premium users.
 * - Admins: Full read/write access to all collections
 * - Premium users: Full read/write access to all collections
 * - Trial users: Read-only access, no export/write capabilities, expires after 5 days
 * - Unverified users: No access until email is verified
 *
 * Data Structure:
 * The data is organized into several top-level collections: /suppliers, /customers, /products, /purchases, and /sales.
 * User profiles are stored in /users collection with role, subscription, and verification status.
 *
 * Key Security Decisions:
 * - Email Verification Required: Users must verify their email before accessing data
 * - Role-Based Access: Admin and premium users have full access; trial users have read-only access
 * - Trial Expiry: Trial users lose write access after 5 days (role will be updated server-side)
 * - Relational Integrity: Subcollection items must correctly reference their parent documents
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated and verified
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Gets the user's document from the /users collection
     */
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /**
     * Checks if user is verified (email verified)
     */
    function isEmailVerified() {
      return isSignedIn() && getUserDoc().emailVerified == true;
    }

    /**
     * Checks if user is admin
     */
    function isAdmin() {
      return isEmailVerified() && getUserDoc().role == 'admin';
    }

    /**
     * Checks if user is premium
     */
    function isPremium() {
      return isEmailVerified() && getUserDoc().subscription == 'premium';
    }

    /**
     * Checks if user is trial (regardless of expiry - server-side will handle expiry)
     */
    function isTrial() {
      return isEmailVerified() && getUserDoc().subscription == 'trial';
    }

    /**
     * Checks if user has write access (admin or premium)
     */
    function canWrite() {
      return isAdmin() || isPremium();
    }

    /**
     * Checks if user has read access (any verified user)
     */
    function canRead() {
      return isEmailVerified();
    }

    /**
     * Checks if the parent purchase document exists
     */
    function parentPurchaseExists(purchaseId) {
      return exists(/databases/$(database)/documents/purchases/$(purchaseId));
    }

    /**
     * Checks if the parent sale document exists
     */
    function parentSaleExists(saleId) {
      return exists(/databases/$(database)/documents/sales/$(saleId));
    }

    /**
     * Validates that a new purchase item's internal purchaseId matches its path
     */
    function hasValidPurchaseItemData(purchaseId) {
      return request.resource.data.purchaseId == purchaseId;
    }

    /**
     * Enforces that the purchaseId within a purchase item cannot be changed after creation
     */
    function isPurchaseItemImmutable() {
      return request.resource.data.purchaseId == resource.data.purchaseId;
    }

    /**
     * Validates that a new sale item's internal saleId matches its path
     */
    function hasValidSaleItemData(saleId) {
      return request.resource.data.saleId == saleId;
    }

    /**
     * Enforces that the saleId within a sale item cannot be changed after creation
     */
    function isSaleItemImmutable() {
      return request.resource.data.saleId == resource.data.saleId;
    }


    // --------------------------------------------------------------------
    // Users Collection Rules
    // --------------------------------------------------------------------

    /**
     * @description Manages user profiles and authentication data
     * @path /users/{uid}
     */
    match /users/{uid} {
      // Users can read their own profile
      allow read: if isSignedIn() && request.auth.uid == uid;
      // Users can create their own profile document (for initial signup)
      allow create: if isSignedIn() && request.auth.uid == uid;
      // Users can update their own profile (except role)
      allow update: if isSignedIn() && request.auth.uid == uid && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
      // Users cannot delete their own profile
      allow delete: if false;
    }

    // Admin can read all user profiles
    match /users/{uid} {
      allow read: if isAdmin();
    }


    // --------------------------------------------------------------------
    // Collection Rules with RBAC
    // --------------------------------------------------------------------

    /**
     * @description Manages supplier data
     * @access Admins and premium users: read/write; Trial users: read-only; Unverified: denied
     */
    match /suppliers/{supplierId} {
      allow read: if canRead();
      allow write: if canWrite();
    }

    /**
     * @description Manages customer data
     * @access Admins and premium users: read/write; Trial users: read-only; Unverified: denied
     */
    match /customers/{customerId} {
      allow read: if canRead();
      allow write: if canWrite();
    }

    /**
     * @description Manages product inventory
     * @access Admins and premium users: read/write; Trial users: read-only; Unverified: denied
     */
    match /products/{productId} {
      allow read: if canRead();
      allow write: if canWrite();
    }

    /**
     * @description Manages purchase orders
     * @access Admins and premium users: read/write; Trial users: read-only; Unverified: denied
     */
    match /purchases/{purchaseId} {
      allow read: if canRead();
      allow write: if canWrite();

      /**
       * @description Manages line items within a purchase order
       */
      match /purchaseItems/{purchaseItemId} {
        allow read: if canRead() && parentPurchaseExists(purchaseId);
        allow create: if canWrite() && parentPurchaseExists(purchaseId) && hasValidPurchaseItemData(purchaseId);
        allow update: if canWrite() && parentPurchaseExists(purchaseId) && resource != null && isPurchaseItemImmutable();
        allow delete: if canWrite() && parentPurchaseExists(purchaseId) && resource != null;
      }
    }

    /**
     * @description Manages sales to customers
     * @access Admins and premium users: read/write; Trial users: read-only; Unverified: denied
     */
    match /sales/{saleId} {
      allow read: if canRead();
      allow write: if canWrite();

      /**
       * @description Manages line items within a sale
       */
      match /saleItems/{saleItemId} {
        allow read: if canRead() && parentSaleExists(saleId);
        allow create: if canWrite() && parentSaleExists(saleId) && hasValidSaleItemData(saleId);
        allow update: if canWrite() && parentSaleExists(saleId) && resource != null && isSaleItemImmutable();
        allow delete: if canWrite() && parentSaleExists(saleId) && resource != null;
      }
    }

    /**
     * @description User notifications and Admin system notifications
     * @access Users can only read/update their own notifications; Admins create all notifications
     * Notification types: 'info', 'success', 'warning', 'error', 'alert' for users
     *                    'admin-system' for app manager system notifications
     */
    match /notifications/{notificationId} {
      // Users can read notifications sent to them (both user notifications and admin system notifications)
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Only admins can create notifications (for both users and other admins)
      allow create: if isAdmin();
      
      // Users and admins can update their own notifications (to mark as read)
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Admins or the notification owner can delete notifications
      allow delete: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
    }
  }
}